{"version":3,"sources":["emitter.js"],"names":["define","types","objects","arrays","klass","events","Event","Listener","slice","Array","prototype","compact","isDefined","isPlainObject","isFunction","isString","mixin","isEmptyObject","safeMixin","parse","event","segs","split","name","ns","join","queues","Map","Emitter","inherit","_prepareArgs","e","args","concat","on","selector","data","callback","ctx","one","self","this","_hub","each","type","fn","undefined","Error","forEach","parsed","push","emit","Object","defineProperty","value","call","arguments","eventName","listeners","len","length","reCompact","i","isImmediatePropagationStopped","listener","startsWith","apply","queueEmit","let","map","get","set","oldTimeout","timeout","delete","window","clearTimeout","setTimeout","size","trigger","listened","_events","off","evts","liveEvents","_","indexOf","queueTrigger"],"mappings":"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","file":"../emitter.js","sourcesContent":["define([\r\n  \"skylark-langx-types\",\r\n  \"skylark-langx-objects\",\r\n  \"skylark-langx-arrays\",\r\n  \"skylark-langx-klass\",\r\n  \"./events\",\r\n  \"./event\",\r\n  \"./listener\"\r\n],function(types,objects,arrays,klass,events,Event,Listener){\r\n    var slice = Array.prototype.slice,\r\n        compact = arrays.compact,\r\n        isDefined = types.isDefined,\r\n        isPlainObject = types.isPlainObject,\r\n        isFunction = types.isFunction,\r\n        isString = types.isString,\r\n        isEmptyObject = types.isEmptyObject,\r\n        mixin = objects.mixin,\r\n        safeMixin = objects.safeMixin;\r\n\r\n    function parse(event) {\r\n        var segs = (\"\" + event).split(\".\");\r\n        return {\r\n            name: segs[0],\r\n            ns: segs.slice(1).join(\" \")\r\n        };\r\n    }\r\n\r\n    \r\n    var queues  = new Map();\r\n\r\n\r\n    var Emitter = Listener.inherit({\r\n        _prepareArgs : function(e,args) {\r\n            if (isDefined(args)) {\r\n                args = [e].concat(args);\r\n            } else {\r\n                args = [e];\r\n            }\r\n            return args;\r\n        },\r\n\r\n        on: function(events, selector, data, callback, ctx, /*used internally*/ one) {\r\n            var self = this,\r\n                _hub = this._hub || (this._hub = {});\r\n\r\n            if (isPlainObject(events)) {\r\n                ctx = callback;\r\n                each(events, function(type, fn) {\r\n                    self.on(type, selector, data, fn, ctx, one);\r\n                });\r\n                return this;\r\n            }\r\n\r\n            if (!isString(selector) && !isFunction(callback)) {\r\n                ctx = callback;\r\n                callback = data;\r\n                data = selector;\r\n                selector = undefined;\r\n            }\r\n\r\n            if (isFunction(data)) {\r\n                ctx = callback;\r\n                callback = data;\r\n                data = null;\r\n            }\r\n\r\n            if (!callback ) {\r\n                throw new Error(\"No callback function\");\r\n            } else if (!isFunction(callback)) {\r\n                throw new Error(\"The callback  is not afunction\");\r\n            }\r\n\r\n            if (isString(events)) {\r\n                events = events.split(/\\s/)\r\n            }\r\n\r\n            events.forEach(function(event) {\r\n                var parsed = parse(event),\r\n                    name = parsed.name,\r\n                    ns = parsed.ns;\r\n\r\n                (_hub[name] || (_hub[name] = [])).push({\r\n                    fn: callback,\r\n                    selector: selector,\r\n                    data: data,\r\n                    ctx: ctx,\r\n                    ns : ns,\r\n                    one: one\r\n                });\r\n            });\r\n\r\n            return this;\r\n        },\r\n\r\n        one: function(events, selector, data, callback, ctx) {\r\n            return this.on(events, selector, data, callback, ctx, 1);\r\n        },\r\n\r\n        emit: function(e /*,argument list*/ ) {\r\n            if (!this._hub) {\r\n                return this;\r\n            }\r\n\r\n            var self = this;\r\n\r\n            if (isString(e)) {\r\n                e = new Event(e); //new CustomEvent(e);\r\n            }\r\n\r\n            Object.defineProperty(e,\"target\",{\r\n                value : this\r\n            });\r\n\r\n            var args = slice.call(arguments, 1);\r\n\r\n            args = this._prepareArgs(e,args);\r\n\r\n            [e.type || e.name, \"all\"].forEach(function(eventName) {\r\n                var parsed = parse(eventName),\r\n                    name = parsed.name,\r\n                    ns = parsed.ns;\r\n\r\n                var listeners = self._hub[name];\r\n                if (!listeners) {\r\n                    return;\r\n                }\r\n\r\n                var len = listeners.length,\r\n                    reCompact = false;\r\n\r\n                for (var i = 0; i < len; i++) {\r\n                    if (e.isImmediatePropagationStopped && e.isImmediatePropagationStopped()) {\r\n                        return this;\r\n                    }\r\n                    var listener = listeners[i];\r\n                    if (ns && (!listener.ns ||  !listener.ns.startsWith(ns))) {\r\n                        continue;\r\n                    }\r\n\r\n                    if (listener.data) {\r\n                        e.data = mixin({}, listener.data, e.data);\r\n                    }\r\n                    if (args.length == 2 && isPlainObject(args[1])) {\r\n                        e.data = e.data || {};\r\n                        mixin(e.data,args[1]);\r\n                    }\r\n\r\n                    listener.fn.apply(listener.ctx, args);\r\n                    if (listener.one) {\r\n                        listeners[i] = null;\r\n                        reCompact = true;\r\n                    }\r\n                }\r\n\r\n                if (reCompact) {\r\n                    self._hub[eventName] = compact(listeners);\r\n                }\r\n\r\n            });\r\n            return this;\r\n        },\r\n\r\n        queueEmit : function (event) {\r\n            const type = event.type || event;\r\n            let map = queues.get(this);\r\n            if (!map) {\r\n                map = new Map();\r\n                queues.set(this, map);\r\n            }\r\n            const oldTimeout = map.get(type);\r\n            map.delete(type);\r\n            window.clearTimeout(oldTimeout);\r\n            const timeout = window.setTimeout(() => {\r\n                if (map.size === 0) {\r\n                    map = null;\r\n                    queues.delete(this);\r\n                }\r\n                this.trigger(event);\r\n            }, 0);\r\n            map.set(type, timeout);\r\n        },\r\n\r\n        listened: function(event) {\r\n            var evtArr = ((this._hub || (this._events = {}))[event] || []);\r\n            return evtArr.length > 0;\r\n        },\r\n\r\n        off: function(events, callback) {\r\n            if (!events) {\r\n              this._hub = null;\r\n              return;\r\n            }\r\n            var _hub = this._hub || (this._hub = {});\r\n            if (isString(events)) {\r\n                events = events.split(/\\s/)\r\n            }\r\n\r\n            events.forEach(function(event) {\r\n                var parsed = parse(event),\r\n                    name = parsed.name,\r\n                    ns = parsed.ns;\r\n\r\n                var evts = _hub[name];\r\n\r\n                if (evts) {\r\n                    var liveEvents = [];\r\n\r\n                    if (callback || ns) {\r\n                        for (var i = 0, len = evts.length; i < len; i++) {\r\n                            \r\n                            if (callback && evts[i].fn !== callback && evts[i].fn._ !== callback) {\r\n                                liveEvents.push(evts[i]);\r\n                                continue;\r\n                            } \r\n\r\n                            if (ns && (!evts[i].ns || evts[i].ns.indexOf(ns)!=0)) {\r\n                                liveEvents.push(evts[i]);\r\n                                continue;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (liveEvents.length) {\r\n                        _hub[name] = liveEvents;\r\n                    } else {\r\n                        delete _hub[name];\r\n                    }\r\n\r\n                }\r\n            });\r\n\r\n            return this;\r\n        },\r\n\r\n        trigger  : function() {\r\n            return this.emit.apply(this,arguments);\r\n        },\r\n\r\n        queueTrigger : function (event) {\r\n            return this.queueEmit.apply(this,arguments);\r\n        }\r\n\r\n    });\r\n\r\n\r\n    return events.Emitter = Emitter;\r\n\r\n})"]}